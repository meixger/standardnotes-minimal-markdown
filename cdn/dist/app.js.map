{"version":3,"file":"app.js","names":["document","addEventListener","event","componentRelay","workingNote","clientData","lastValue","lastUUID","editor","ignoreTextChange","initialLoad","loadComponentRelay","initialPermissions","name","ComponentRelay","targetWindow","window","onReady","platform","body","classList","add","loadEditor","setOption","isMobile","handleRequestForContentHeight","undefined","streamContextItem","note","onReceivedNote","saveNote","saveItemWithPresave","getValue","content","text","preview_plain","preview_html","uuid","isMetadataUpdate","getDoc","setValue","clearHistory","spellcheck","CodeMirror","fromTextArea","getElementById","mode","lineWrapping","extraKeys","inputStyle","getInputStyleForEnvironment","setSize","on","_componentRelay$envir","environment"],"sources":["app.js"],"sourcesContent":["document.addEventListener('DOMContentLoaded', function (event) {\r\n  let componentRelay\r\n  let workingNote, clientData\r\n  let lastValue, lastUUID\r\n  let editor\r\n  let ignoreTextChange = false\r\n  let initialLoad = true\r\n\r\n  function loadComponentRelay() {\r\n    const initialPermissions = [{ name: 'stream-context-item' }]\r\n    componentRelay = new ComponentRelay({\r\n      initialPermissions,\r\n      targetWindow: window,\r\n      onReady: function () {\r\n        const platform = componentRelay.platform\r\n        if (platform) {\r\n          document.body.classList.add(platform)\r\n        }\r\n\r\n        loadEditor()\r\n\r\n        // only use CodeMirror selection color if we're not on mobile.\r\n        editor.setOption('styleSelectedText', !componentRelay.isMobile)\r\n      },\r\n      handleRequestForContentHeight: () => {\r\n        return undefined\r\n      },\r\n    })\r\n\r\n    componentRelay.streamContextItem((note) => {\r\n      onReceivedNote(note)\r\n    })\r\n  }\r\n\r\n  function saveNote() {\r\n    if (workingNote) {\r\n      // Be sure to capture this object as a variable, as this.note may be reassigned in `streamContextItem`, so by the time\r\n      // you modify it in the presave block, it may not be the same object anymore, so the presave values will not be applied to\r\n      // the right object, and it will save incorrectly.\r\n      let note = workingNote\r\n\r\n      componentRelay.saveItemWithPresave(note, () => {\r\n        lastValue = editor.getValue()\r\n        note.content.text = lastValue\r\n        note.clientData = clientData\r\n\r\n        // clear previews\r\n        note.content.preview_plain = null\r\n        note.content.preview_html = null\r\n      })\r\n    }\r\n  }\r\n\r\n  function onReceivedNote(note) {\r\n    if (note.uuid !== lastUUID) {\r\n      // Note changed, reset last values\r\n      lastValue = null\r\n      initialLoad = true\r\n      lastUUID = note.uuid\r\n    }\r\n\r\n    workingNote = note\r\n\r\n    // Only update UI on non-metadata updates.\r\n    if (note.isMetadataUpdate) {\r\n      return\r\n    }\r\n\r\n    clientData = note.clientData\r\n\r\n    if (editor) {\r\n      if (note.content.text !== lastValue) {\r\n        ignoreTextChange = true\r\n        editor.getDoc().setValue(workingNote.content.text)\r\n        ignoreTextChange = false\r\n      }\r\n\r\n      if (initialLoad) {\r\n        initialLoad = false\r\n        editor.getDoc().clearHistory()\r\n      }\r\n\r\n      editor.setOption('spellcheck', workingNote.content.spellcheck)\r\n    }\r\n  }\r\n\r\n  function loadEditor() {\r\n    editor = CodeMirror.fromTextArea(document.getElementById('code'), {\r\n      mode: 'gfm',\r\n      lineWrapping: true,\r\n      extraKeys: { 'Alt-F': 'findPersistent' },\r\n      inputStyle: getInputStyleForEnvironment(),\r\n    })\r\n    editor.setSize(undefined, '100%')\r\n\r\n    editor.on('change', function () {\r\n      if (ignoreTextChange) {\r\n        return\r\n      }\r\n      saveNote()\r\n    })\r\n  }\r\n\r\n  function getInputStyleForEnvironment() {\r\n    const environment = componentRelay.environment ?? 'web'\r\n    return environment === 'mobile' ? 'textarea' : 'contenteditable'\r\n  }\r\n\r\n  loadComponentRelay()\r\n})\r\n"],"mappings":"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","ignoreList":[]}